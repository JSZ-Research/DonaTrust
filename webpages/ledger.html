<!DOCTYPE html>
<html lang="en">
<head>
    <title>DonaTrust | Solana Ledger</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="assets/css/main.css" />
</head>
<body class="is-preload">
    <header id="header">
        <h1 id="logo"><a href="./index.html">DonaTrust</a></h1>
    </header>

    <div id="main">
        <div class="inner">
            <header class="major">
                <h1>Blockchain Ledger (Solana)</h1>
                <p>Verify donations on the Solana Devnet network.</p>
            </header>
            <div class="ledger-status" id="ledgerStatus">
                <button id="connectBtn" class="button primary">Connect Phantom Wallet</button>
            </div>
            <div id="ledgerData" style="display:none; margin-top: 2em;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@coral-xyz/anchor@latest/dist/browser/anchor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>

    <script>
        // 1. 配置 (使用你截图中的 Program ID)
        const programId = new solanaWeb3.PublicKey("6biq8rnJUgQRLKavwXsbnuPX6aVB..."); 
        const network = "https://api.devnet.solana.com";
        const connection = new solanaWeb3.Connection(network, "processed");

        // 2. IDL 内容 (为了方便直接写在 script 里，或者你也可以用 fetch 读取 json)
        // 注意：这里的结构要和你下载的 JSON 保持一致
        let idl; 

        async function connectWallet() {
            if (!window.solana) return alert("Please install Phantom!");
            try {
                const resp = await window.solana.connect();
                document.getElementById("connectBtn").innerText = "Linked: " + resp.publicKey.toString().slice(0, 6);
                
                // 加载 IDL 文件
                const response = await fetch('./src/charity_idl.json');
                idl = await response.json();
                
                loadLedger();
            } catch (err) { console.error(err); }
        }

        async function loadLedger() {
            const provider = new anchor.AnchorProvider(connection, window.solana, { preflightCommitment: "processed" });
            const program = new anchor.Program(idl, programId, provider);

            try {
                // 获取链上所有活动账户
                const allCampaigns = await program.account.campaignAccount.all();
                const ledgerData = document.getElementById("ledgerData");
                ledgerData.style.display = "block";
                
                let html = "<h3>Live Transparency Ledger</h3>";
                allCampaigns.forEach(c => {
                    const acc = c.account;
                    html += `<div style="border: 1px solid #ddd; padding: 10px; margin: 10px;">
                        <strong>${acc.title}</strong><br>
                        Goal: ${acc.target / 1000000000} SOL | Collected: ${acc.amountCollected / 1000000000} SOL
                    </div>`;
                });
                ledgerData.innerHTML = html;
            } catch (err) { console.error(err); }
        }

        document.getElementById("connectBtn").addEventListener("click", connectWallet);
    </script>
</body>
</html>